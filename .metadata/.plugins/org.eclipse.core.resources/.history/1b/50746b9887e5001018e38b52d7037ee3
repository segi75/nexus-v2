plugins {
    id 'java'
    id 'org.springframework.boot'
    id 'io.spring.dependency-management'
    id 'eclipse' // [수정 1] eclipse 설정 블록을 위해 필수 추가
}

group = 'com.nexus.sample'
version = '0.0.1-SNAPSHOT'

// [옵션] Java 컴파일 시 인코딩 및 파라미터 정보 유지
tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
    options.compilerArgs << '-parameters'
    
    // [수정 2] Annotation Processor가 생성하는 파일 위치를 'src-gen'으로 강제 지정
    // 이 설정이 없으면 기본적으로 build/generated/... 경로에 생성됩니다.
    options.generatedSourceOutputDirectory = file('src-gen')
}

// [옵션] MapStruct가 Spring Bean으로 등록되도록 전역 설정 (매번 componentModel='spring' 안 써도 됨)
tasks.withType(JavaCompile) {
    options.compilerArgs += [
        '-Amapstruct.defaultComponentModel=spring'
    ]
}

dependencies {
    // 1. NEXUS BOM 적용 (버전 통제)
    implementation platform(project(':nexus-bom'))

    // 2. NEXUS 핵심 스타터 적용
    implementation project(':nexus-web-starter')     // 웹 표준
    implementation project(':nexus-obs-starter')     // 로깅/추적
    implementation project(':nexus-mybatis-starter') // DB
    implementation project(':nexus-tx')              // 트랜잭션
    implementation project(':nexus-security-starter') // 시큐리티
    implementation project(':nexus-migration')        // DB 마이그레이션

    // 3. DB 드라이버 (H2, MSSQL)
    runtimeOnly 'com.h2database:h2'
    runtimeOnly 'com.microsoft.sqlserver:mssql-jdbc'

    // 4. 유틸 (Lombok)
    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok'
    
    // Lombok과 MapStruct 연결고리
    annotationProcessor 'org.projectlombok:lombok-mapstruct-binding:0.2.0'
    
    // 5. 테스트
    testImplementation project(':nexus-test-starter')
  
    // 6. MapStruct (DTO 변환 핵심)
    // Tip: 가능하다면 버전 정보도 nexus-bom으로 옮기는 것을 추천합니다.
    implementation 'org.mapstruct:mapstruct:1.5.5.Final'
    annotationProcessor 'org.mapstruct:mapstruct-processor:1.5.5.Final'
}

// 소스셋 설정: src-gen을 소스 경로에 포함
sourceSets {
    main {
        java {
            srcDirs 'src/main/java', 'src-gen'
        }
    }
}

test {
    useJUnitPlatform()
}

// 이클립스 설정: src-gen 폴더가 없으면 만들고 소스 폴더로 등록
eclipse {
    classpath {
        file {
            whenMerged {
                def srcGenPath = 'src-gen'
                def srcGen = entries.find { it.path == srcGenPath }
                
                // src-gen 폴더가 실제로 없으면 생성 (에러 방지)
                def srcGenDir = file(srcGenPath)
                if (!srcGenDir.exists()) {
                    srcGenDir.mkdirs()
                }

                if (srcGen == null) {
                    // src-gen을 소스 폴더(kind: src)로 추가
                    def sourceFolder = new org.gradle.plugins.ide.eclipse.model.SourceFolder(srcGenPath, null)
                    entries.add(sourceFolder)
                }
            }
        }
    }
}

// clean 태스크 실행 시 src-gen 폴더도 같이 정리할지 결정 (선택 사항)
clean {
    delete 'src-gen'
}