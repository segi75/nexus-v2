package com.nexus.migration.config;

import javax.sql.DataSource;

import org.flywaydb.core.Flyway;
import org.springframework.boot.autoconfigure.AutoConfiguration;
import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.boot.autoconfigure.flyway.FlywayAutoConfiguration;
import org.springframework.boot.autoconfigure.flyway.FlywayConfigurationCustomizer;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.boot.jdbc.DatabaseDriver;
import org.springframework.context.annotation.Bean;

import com.nexus.migration.properties.NexusMigrationProperties;

import lombok.extern.slf4j.Slf4j;

@Slf4j
@AutoConfiguration(before = FlywayAutoConfiguration.class) // Spring 기본 설정보다 먼저 동작
@ConditionalOnClass(Flyway.class)
@EnableConfigurationProperties(NexusMigrationProperties.class)
@ConditionalOnProperty(prefix = "nexus.migration", name = "enabled", havingValue = "true", matchIfMissing = true)
public class NexusMigrationAutoConfiguration {

    @Bean
    public FlywayConfigurationCustomizer nexusFlywayCustomizer(DataSource dataSource) {
        return configuration -> {
            // 1. 현재 연결된 DB 종류 파악
            // (H2 -> "h2", MSSQL -> "sqlserver")
            DatabaseDriver driver = DatabaseDriver.fromDataSource(dataSource);
            String vendor = driver.getId(); 

            // 2. 벤더별 폴더 경로 매핑
            // sqlserver인 경우 폴더명을 "mssql"로 통일 (취향 차이이나 명시적 관리를 위해)
            String folderName = "sqlserver".equals(vendor) ? "mssql" : vendor;
            String migrationPath = "classpath:db/migration/" + folderName;

            log.info("[NEXUS] DB Migration detected database: [{}] -> path: [{}]", vendor, migrationPath);

            // 3. Flyway 설정 강제 적용
            configuration
                .locations(migrationPath)     // 경로 자동 지정
                .baselineOnMigrate(true)      // 기존 DB가 있어도 이력 관리 시작
                .validateOnMigrate(true);     // SQL 파일 변조 검사
        };
    }
}