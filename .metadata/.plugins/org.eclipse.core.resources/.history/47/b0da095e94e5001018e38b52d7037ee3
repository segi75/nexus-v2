package com.nexus.mybatis.config;

import org.mybatis.spring.boot.autoconfigure.ConfigurationCustomizer;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;

import com.nexus.mybatis.dialect.NexusDialect;
import com.nexus.mybatis.dialect.NexusMssqlDialect;
import com.nexus.mybatis.interceptor.AutoFillingInterceptor;
import com.nexus.mybatis.interceptor.NexusAuditorAware; // 같은 프로젝트 내 파일 참조

@Configuration
public class NexusMybatisConfig {

    // 1. MyBatis 기본 설정 (CamelCase 등)
    @Bean
    public ConfigurationCustomizer nexusMyBatisCustomizer() {
        return configuration -> {
            configuration.setMapUnderscoreToCamelCase(true);
            configuration.setDefaultStatementTimeout(30);
            configuration.setDefaultFetchSize(100);
            configuration.setJdbcTypeForNull(org.apache.ibatis.type.JdbcType.NULL);
        };
    }
    
    // 2. MSSQL 방언 설정
    @Bean
    public NexusDialect nexusDialect() {
        return new NexusMssqlDialect();
    }

    // 3. [임시] 기본 사용자 ID 제공자 (나중에 시큐리티 붙으면 자동으로 대체됨)
    @Bean
    @ConditionalOnMissingBean
    public NexusAuditorAware defaultAuditorAware() {
        return () -> java.util.Optional.of("SYSTEM");
    }

    // 4. 자동 채움 인터셉터 등록
    @Bean
    public AutoFillingInterceptor autoFillingInterceptor(NexusAuditorAware auditorAware) {
        return new AutoFillingInterceptor(auditorAware);
    }
}