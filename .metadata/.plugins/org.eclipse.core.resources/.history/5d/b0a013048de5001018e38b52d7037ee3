package com.nexus.mybatis.config;

import org.mybatis.spring.boot.autoconfigure.ConfigurationCustomizer;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import com.nexus.mybatis.dialect.NexusDialect;
import com.nexus.mybatis.dialect.NexusMssqlDialect;
// import com.nexus.mybatis.plugin.NexusSqlSafetyInterceptor; // (만약 이 파일이 없다면 주석 처리하세요)

// [추가] 자동 필링 기능을 위한 import
import com.nexus.mybatis.interceptor.AutoFillingInterceptor;
import com.nexus.core.security.NexusAuditorAware;

@Configuration
public class NexusMybatisConfig { // 파일명과 일치 (Mybatis)

    /**
     * MyBatis 표준 설정을 강제 적용합니다.
     */
    @Bean
    public ConfigurationCustomizer nexusMyBatisCustomizer() {
        return configuration -> {
            // 1. CamelCase 자동 변환
            configuration.setMapUnderscoreToCamelCase(true);

            // 2. 쿼리 타임아웃 & Fetch Size
            configuration.setDefaultStatementTimeout(30);
            configuration.setDefaultFetchSize(100);
            
            // 3. NULL 처리
            configuration.setJdbcTypeForNull(org.apache.ibatis.type.JdbcType.NULL);
            
            // 4. 안전 장치 (클래스가 있다면 주석 해제)
            // configuration.addInterceptor(new NexusSqlSafetyInterceptor());
        };
    }
    
    /**
     * MSSQL 방언 등록
     */
    @Bean
    public NexusDialect nexusDialect() {
        return new NexusMssqlDialect();
    }

    /**
     * [New] MyBatis 자동 필링 인터셉터 등록
     * 이 빈(Bean)을 등록하면, Spring Boot가 알아서 MyBatis에 끼워넣어 줍니다.
     */
    @Bean
    public AutoFillingInterceptor autoFillingInterceptor(NexusAuditorAware auditorAware) {
        return new AutoFillingInterceptor(auditorAware);
    }
}