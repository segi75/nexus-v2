package com.nexus.obs;

import com.nexus.obs.aop.NexusPerformanceAspect;
import com.nexus.obs.tracing.NexusTraceIdFilter; // import ì¶”ê°€
import org.springframework.boot.autoconfigure.AutoConfiguration;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.boot.web.servlet.FilterRegistrationBean; // import ì¶”ê°€
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.ComponentScan;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@AutoConfiguration
@EnableConfigurationProperties(NexusObsProperties.class)
@ConditionalOnProperty(prefix = "nexus.obs", name = "enabled", havingValue = "true", matchIfMissing = true)
@ComponentScan(basePackages = "com.nexus.obs")
public class NexusObsAutoConfiguration {

    public NexusObsAutoConfiguration() {
        log.info("ğŸš€ Nexus Observability Module Initialized...");
    }

    // 1. Trace ID í•„í„° (ê¸°ì¡´ ì½”ë“œ)
    @Bean
    @ConditionalOnProperty(prefix = "nexus.obs", name = "tracing-enabled", havingValue = "true", matchIfMissing = true)
    public FilterRegistrationBean<NexusTraceIdFilter> nexusTraceIdFilter() {
        FilterRegistrationBean<NexusTraceIdFilter> registrationBean = new FilterRegistrationBean<>();
        registrationBean.setFilter(new NexusTraceIdFilter());
        registrationBean.addUrlPatterns("/*"); // ëª¨ë“  ìš”ì²­ì— ì ìš©
        registrationBean.setOrder(Integer.MIN_VALUE); // ìµœìš°ì„  ìˆœìœ„ ë³´ì¥
        return registrationBean;
    }
    
    // 2. [ì‹ ê·œ ì¶”ê°€] ì„±ëŠ¥ ì¸¡ì • AOP ë“±ë¡
    @Bean
    @ConditionalOnProperty(prefix = "nexus.obs", name = "metrics-enabled", havingValue = "true", matchIfMissing = true)
    public NexusPerformanceAspect nexusPerformanceAspect(MeterRegistry registry) {
        // MeterRegistryëŠ” ìŠ¤í”„ë§ ë¶€íŠ¸ê°€ ìë™ìœ¼ë¡œ ì£¼ì…í•´ì¤ë‹ˆë‹¤.
        return new NexusPerformanceAspect(registry);
    }
}